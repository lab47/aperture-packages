formula = r"""
class Mapserver < Formula
  desc "Publish spatial data and interactive mapping apps to the web"
  homepage "https://mapserver.org/"
  url "https://download.osgeo.org/mapserver/mapserver-7.6.3.tar.gz"
  sha256 "0e0db478dabddee50498cd89669340f160a0437fed5a9f823022b19e2f150365"
  license "MIT"
  revision 2

  livecheck do
    url "https://mapserver.org/download.html"
    regex(/href=.*?mapserver[._-]v?(\d+(?:\.\d+)+)\.t/i)
  end

  bottle do
    sha256 cellar: :any, big_sur:  "383800e38f0fca0ce658159e828049b3d1cf1aa74abd39b2a40bacaf0e5f3550"
    sha256 cellar: :any, catalina: "1078b18f57fccc14a09bdf847738a099eb9fe23b79df904667d3ef4454ea1710"
    sha256 cellar: :any, mojave:   "0b32e025ea3c5fd55cc6bb7e6fdf91012007d9f5fd7a9866b1ebcb135e94091f"
  end

  depends_on "cmake" => :build
  depends_on "pkg-config" => :build
  depends_on "swig@3" => :build
  depends_on "cairo"
  depends_on "fcgi"
  depends_on "freetype"
  depends_on "gd"
  depends_on "gdal"
  depends_on "geos"
  depends_on "giflib"
  depends_on "libpng"
  depends_on "postgresql"
  depends_on "proj@7"
  depends_on "protobuf-c"
  depends_on "python@3.9"

  uses_from_macos "curl"

  def install
    ENV.cxx11

    args = std_cmake_args + %w[
      -DWITH_CLIENT_WFS=ON
      -DWITH_CLIENT_WMS=ON
      -DWITH_CURL=ON
      -DWITH_FCGI=ON
      -DWITH_FRIBIDI=OFF
      -DWITH_GDAL=ON
      -DWITH_GEOS=ON
      -DWITH_HARFBUZZ=OFF
      -DWITH_KML=ON
      -DWITH_OGR=ON
      -DWITH_POSTGIS=ON
      -DWITH_PYTHON=ON
      -DWITH_SOS=ON
      -DWITH_WFS=ON
    ]
    args << "-DPYTHON_EXECUTABLE=#{Formula["python@3.9"].opt_bin/"python3"}"
    args << "-DPHP_EXTENSION_DIR=#{lib}/php/extensions"

    # Install within our sandbox
    inreplace "mapscript/python/CMakeLists.txt" do |s|
      s.gsub! "${PYTHON_LIBRARIES}", "-Wl,-undefined,dynamic_lookup"
    end

    # Using rpath on python module seems to cause problems if you attempt to
    # import it with an interpreter it wasn't built against.
    # 2): Library not loaded: @rpath/libmapserver.1.dylib
    args << "-DCMAKE_SKIP_RPATH=ON"

    mkdir "build" do
      system "cmake", "..", *args
      system "make", "install"
      cd "mapscript/python" do
        system Formula["python@3.9"].opt_bin/"python3", *Language::Python.setup_install_args(prefix)
      end
    end
  end

  test do
    assert_match version.to_s, shell_output("#{bin}/mapserv -v")
    system Formula["python@3.9"].opt_bin/"python3", "-c", "import mapscript"
  end
end

"""

import "homebrew-install" as hi

import "autoconf" as i0, "automake" as i1, "bison" as i2, "cairo" as i3, "cfitsio" as i4, "cmake" as i5, "cython" as i6, "doxygen" as i7, "epsilon" as i8, "expat" as i9, "fcgi" as i10, "fontconfig" as i11, "freetype" as i12, "freexl" as i13, "gcc" as i14, "gd" as i15, "gdal" as i16, "gdbm" as i17, "geos" as i18, "gettext" as i19, "giflib" as i20, "glib" as i21, "gmp" as i22, "gobject-introspection" as i23, "hdf5" as i24, "icu4c" as i25, "isl" as i26, "jpeg" as i27, "json-c" as i28, "krb5" as i29, "libdap" as i30, "libffi" as i31, "libgeotiff" as i32, "libmpc" as i33, "libpng" as i34, "libpq" as i35, "libpthread-stubs" as i36, "librttopo" as i37, "libspatialite" as i38, "libtiff" as i39, "libtool" as i40, "libx11" as i41, "libxau" as i42, "libxcb" as i43, "libxdmcp" as i44, "libxext" as i45, "libxml2" as i46, "libxrender" as i47, "little-cms2" as i48, "lzo" as i49, "m4" as i50, "meson" as i51, "minizip" as i52, "mpdecimal" as i53, "mpfr" as i54, "netcdf" as i55, "ninja" as i56, "nspr" as i57, "nss" as i58, "numpy" as i59, "openblas" as i60, "openjpeg" as i61, "openssl@1.1" as i62, "pcre" as i63, "pixman" as i64, "pkg-config" as i65, "poppler" as i66, "popt" as i67, "postgresql" as i68, "proj@7" as i69, "protobuf" as i70, "protobuf-c" as i71, "python@3.7" as i72, "python@3.8" as i73, "python@3.9" as i74, "qt@5" as i75, "readline" as i76, "six" as i77, "sphinx-doc" as i78, "sqlite" as i79, "swig" as i80, "swig@3" as i81, "szip" as i82, "tcl-tk" as i83, "unixodbc" as i84, "util-macros" as i85, "webp" as i86, "xcb-proto" as i87, "xerces-c" as i88, "xorgproto" as i89, "xtrans" as i90, "xz" as i91, "zstd" as i92

pkg(
  name: "mapserver",
  version: "7.6.3",
  dependencies: [hi, i0, i1, i2, i3, i4, i5, i6, i7, i8, i9, i10, i11, i12, i13, i14, i15, i16, i17, i18, i19, i20, i21, i22, i23, i24, i25, i26, i27, i28, i29, i30, i31, i32, i33, i34, i35, i36, i37, i38, i39, i40, i41, i42, i43, i44, i45, i46, i47, i48, i49, i50, i51, i52, i53, i54, i55, i56, i57, i58, i59, i60, i61, i62, i63, i64, i65, i66, i67, i68, i69, i70, i71, i72, i73, i74, i75, i76, i77, i78, i79, i80, i81, i82, i83, i84, i85, i86, i87, i88, i89, i90, i91, i92],

  def install(ctx) {
    ctx.write_file(join(ctx.build, "mapserver.rb"), formula)
    ctx.system("homebrew-install", ctx.prefix, ctx.state_dir, "./mapserver.rb")
  }
)
