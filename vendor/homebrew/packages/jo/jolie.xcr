formula = r"""
class Jolie < Formula
  desc "Service-oriented programming language"
  homepage "https://www.jolie-lang.org/"
  url "https://github.com/jolie/jolie/releases/download/v1.10.4/jolie-1.10.4.jar"
  sha256 "45f4882b9e78dac8728fe75b7ae827799a441b3298c5d2b585ae0d85c5f07fb7"
  license "LGPL-2.1-only"

  depends_on "openjdk"

  def install
    system Formula["openjdk"].opt_bin/"java",
    "-jar", "jolie-#{version}.jar",
    "--jolie-home", libexec,
    "--jolie-launchers", libexec/"bin"
    bin.install Dir["#{libexec}/bin/*"]
    bin.env_script_all_files libexec/"bin",
      JOLIE_HOME: "${JOLIE_HOME:-#{libexec}}",
      JAVA_HOME:  "${JAVA_HOME:-#{Formula["openjdk"].opt_prefix}}"
  end

  test do
    file = testpath/"test.ol"
    file.write <<~EOS
      from Console import Console, ConsoleIface

      interface PowTwoInterface { OneWay: powTwo( int ) }

      service main(){

        outputPort Console { interfaces: ConsoleIface }
        embed Console in Console

        inputPort In {
          location: "local://testPort"
          interfaces: PowTwoInterface
        }

        outputPort Self {
          location: "local://testPort"
          interfaces: PowTwoInterface
        }

        init {
          powTwo@Self( 4 )
        }

        main {
          powTwo( x )
          println@Console( x * x )()
        }

      }
    EOS

    out = shell_output("#{bin}/jolie #{file}").strip

    assert_equal "16", out
  end
end

"""

import "homebrew-install" as hi

import "openjdk" as i0

pkg(
  name: "jolie",
  version: "1.10.4",
  description: "Service-oriented programming language",
  url: "https://www.jolie-lang.org/",
  metadata: %{
    "license": "LGPL-2.1-only",
    "source": "homebrew",
  },
  dependencies: [hi, i0],

  def install(ctx) {
    ctx.write_file(join(ctx.build, "jolie.rb"), formula)
    ctx.system("homebrew-install", ctx.prefix, ctx.state_dir, "./jolie.rb")
  }
)
